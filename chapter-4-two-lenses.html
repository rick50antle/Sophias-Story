<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 4: Two Lenses | Sofia's Story</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans 3', sans-serif; background: linear-gradient(135deg, #faf8f3 0%, #f5f1e8 100%); min-height: 100vh; }
        .narrative-font { font-family: 'Cormorant Garamond', serif; }
        input:focus, textarea:focus, button:focus { outline: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
/**
 * Chapter 4: Two Lenses
 * Sofia's Story — Accounting Chapter Series
 *
 * @version 1.0
 * @date 2026-02-07
 * @description Sofia buys buckets split between ClearCurrent and PureAccess.
 *   The learner records the same transaction for two entities and discovers
 *   that what changed is the representation, not the economic reality.
 *   Covers Arc Phase 5.
 */

const { useState } = React;

// ─── Color Palette ───────────────────────────────────────────
const colors = {
    primary: '#00356b', primaryLight: '#1a4a7a',
    sand: '#f5f1e8', sandLight: '#faf8f3',
    earth: '#8b7355', earthLight: '#d4c4a8', earthDark: '#5c4d3d',
    accent: '#c9a227', accentWarm: '#d4a84b',
    textDark: '#2c2416', textMuted: '#6b5d4d',
    clay: '#c4a574', clayLight: '#e8dcc8', clayDark: '#a08050',
    success: '#22c55e', successBg: '#f0fdf4',
    warning: '#f59e0b', warningBg: '#fffbeb',
    error: '#dc2626', errorBg: '#fef2f2',
    clearcurrent: '#0369a1', clearcurrentBg: '#e0f2fe',
    pureaccess: '#15803d', pureaccessBg: '#f0fdf4',
};

// ─── Sound Functions ─────────────────────────────────────────
const createAudioContext = () => new (window.AudioContext || window.webkitAudioContext)();
const playSuccessTone = () => { try { const ctx = createAudioContext(); [523.25,659.25,783.99].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.frequency.value=f;o.type='sine'; const t=ctx.currentTime+i*0.1; g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.3,t+0.02);g.gain.exponentialRampToValueAtTime(0.01,t+0.15); o.start(t);o.stop(t+0.25); }); setTimeout(()=>ctx.close(),600); } catch(e){} };
const playSoftNope = () => { try { const ctx = createAudioContext(); [400,300].forEach((f,i) => { const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.frequency.value=f;o.type='sine'; const t=ctx.currentTime+i*0.12; g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.2,t+0.02);g.gain.exponentialRampToValueAtTime(0.01,t+0.12); o.start(t);o.stop(t+0.17); }); setTimeout(()=>ctx.close(),400); } catch(e){} };
const playBuzzer = () => { try { const ctx = createAudioContext(); const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.frequency.value=150;o.type='sawtooth'; const t=ctx.currentTime; g.gain.setValueAtTime(0.25,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3); o.start(t);o.stop(t+0.35); setTimeout(()=>ctx.close(),400); } catch(e){} };
const playContinueClick = () => { try { const ctx = createAudioContext(); const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g);g.connect(ctx.destination); o.frequency.value=600;o.type='sine'; const t=ctx.currentTime; g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.15,t+0.01);g.gain.exponentialRampToValueAtTime(0.01,t+0.08); o.start(t);o.stop(t+0.1); setTimeout(()=>ctx.close(),150); } catch(e){} };

// ─── SVG Icons ───────────────────────────────────────────────
const ChevronRight = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 5l7 7-7 7"/></svg>);
const ChevronDown = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9l6 6 6-6"/></svg>);
const ChevronUp = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 15l-6-6-6 6"/></svg>);
const BookIcon = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>);
const RestartIcon = () => (<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>);
const InfoIcon = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>);
const TrophyIcon = () => (<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>);
const CheckCircleIcon = () => (<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/></svg>);

// ─── Main Component ──────────────────────────────────────────
function Chapter4() {
    const phaseOrder = ['welcome', 'clearcurrent', 'pureaccess', 'comparison', 'complete'];
    const [phase, setPhase] = useState('welcome');

    // UI state
    const [showGlossary, setShowGlossary] = useState(false);
    const [showCreativeNote, setShowCreativeNote] = useState(false);
    const [devMode, setDevMode] = useState(false);
    const [headerClickCount, setHeaderClickCount] = useState(0);

    // Q1: Two-choice (ClearCurrent)
    const [q1Choice, setQ1Choice] = useState(null);
    const [q1Submitted, setQ1Submitted] = useState(false);
    const [q1Attempts, setQ1Attempts] = useState(0);

    // Q2: Two-choice (PureAccess)
    const [q2Choice, setQ2Choice] = useState(null);
    const [q2Submitted, setQ2Submitted] = useState(false);
    const [q2Attempts, setQ2Attempts] = useState(0);

    // Q3: Two-choice with explanation
    const [q3Choice, setQ3Choice] = useState(null);
    const [q3Explanation, setQ3Explanation] = useState('');
    const [q3Submitted, setQ3Submitted] = useState(false);
    const [q3Attempts, setQ3Attempts] = useState(0);

    // Q4: Open reflection
    const [q4Answer, setQ4Answer] = useState('');
    const [q4Submitted, setQ4Submitted] = useState(false);

    // Progress
    const currentPhaseIndex = phaseOrder.indexOf(phase);
    const progress = Math.round((currentPhaseIndex / (phaseOrder.length - 1)) * 100);

    const handleHeaderClick = () => {
        const n = headerClickCount + 1;
        setHeaderClickCount(n);
        if (n >= 3) { setDevMode(!devMode); setHeaderClickCount(0); }
    };

    const handleRestart = () => {
        playContinueClick(); setPhase('welcome');
        setShowCreativeNote(false);
        setQ1Choice(null); setQ1Submitted(false); setQ1Attempts(0);
        setQ2Choice(null); setQ2Submitted(false); setQ2Attempts(0);
        setQ3Choice(null); setQ3Explanation(''); setQ3Submitted(false); setQ3Attempts(0);
        setQ4Answer(''); setQ4Submitted(false);
    };

    // Q1 handler
    const handleQ1 = (choice) => {
        if (q1Submitted) return;
        setQ1Choice(choice);
        if (choice === 'inventory') {
            playSuccessTone(); setQ1Submitted(true);
        } else {
            const n = q1Attempts + 1; setQ1Attempts(n);
            if (n >= 3) { playBuzzer(); setQ1Submitted(true); setQ1Choice('inventory'); }
            else { playSoftNope(); }
        }
    };

    // Q2 handler
    const handleQ2 = (choice) => {
        if (q2Submitted) return;
        setQ2Choice(choice);
        if (choice === 'supplies') {
            playSuccessTone(); setQ2Submitted(true);
        } else {
            const n = q2Attempts + 1; setQ2Attempts(n);
            if (n >= 3) { playBuzzer(); setQ2Submitted(true); setQ2Choice('supplies'); }
            else { playSoftNope(); }
        }
    };

    // Q3 handler
    const handleQ3Submit = () => {
        if (!q3Choice || !q3Explanation.trim()) return;
        if (q3Choice === 'no') {
            playSuccessTone(); setQ3Submitted(true);
        } else {
            const n = q3Attempts + 1; setQ3Attempts(n);
            if (n >= 3) { playBuzzer(); setQ3Submitted(true); setQ3Choice('no'); }
            else { playSoftNope(); }
        }
    };

    // Q4 handler
    const handleQ4Submit = () => {
        if (q4Answer.trim().length >= 10) {
            playSuccessTone(); setQ4Submitted(true);
        }
    };

    // ─── Styles ─────────────────────────────────────────
    const s = {
        container: { minHeight: '100vh', background: `linear-gradient(135deg, ${colors.sandLight} 0%, ${colors.sand} 100%)` },
        main: { padding: '16px', maxWidth: '720px', margin: '0 auto' },
        card: { background: 'white', borderRadius: '12px', padding: '20px', marginBottom: '16px', boxShadow: '0 1px 3px rgba(0,0,0,0.08)' },
        narrativeBlock: { padding: '20px', borderRadius: '12px', borderLeft: `4px solid ${colors.accent}`, background: colors.sand, marginBottom: '16px', fontFamily: "'Cormorant Garamond', serif", fontSize: '18px', lineHeight: 1.7, color: colors.textDark, fontStyle: 'italic' },
        btn: { width: '100%', padding: '14px', borderRadius: '12px', border: 'none', fontWeight: 600, fontSize: '16px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', transition: 'all 0.2s' },
        primaryBtn: { background: colors.primary, color: 'white' },
        outlineBtn: { background: 'transparent', border: `2px solid ${colors.primary}`, color: colors.primary },
        hintBox: { padding: '14px', borderRadius: '10px', background: colors.warningBg, marginTop: '10px', fontSize: '14px', color: '#92400e' },
        successBox: { padding: '14px', borderRadius: '10px', background: colors.successBg, border: `1px solid ${colors.success}`, marginTop: '10px', fontSize: '14px', color: '#166534' },
        revealBox: { padding: '14px', borderRadius: '10px', background: colors.warningBg, border: `1px solid ${colors.warning}`, marginTop: '10px', fontSize: '14px', color: '#92400e' },
        insightBox: { padding: '20px', borderRadius: '12px', border: `2px solid ${colors.accent}`, background: '#fef9e7', marginBottom: '16px', fontSize: '15px', color: colors.earthDark, lineHeight: 1.6 },
    };

    // ─── Header ─────────────────────────────────────────
    const Header = () => (
        <div style={{ background: colors.primary, borderRadius: '12px', padding: '16px', marginBottom: '16px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <div onClick={handleHeaderClick} style={{ cursor: 'pointer' }}>
                    <span style={{ color: 'white', fontWeight: 700, fontSize: '17px' }}>Chapter 4: Two Lenses</span>
                    <p style={{ color: colors.earthLight, fontSize: '13px', marginTop: '4px' }}>Sofia's Story &bull; ~12 min</p>
                </div>
                <div style={{ display: 'flex', gap: '4px' }}>
                    <button onClick={() => setShowGlossary(true)} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '8px', cursor: 'pointer', color: 'white' }} title="Glossary"><BookIcon /></button>
                    <button onClick={handleRestart} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '8px', cursor: 'pointer', color: 'white' }} title="Restart"><RestartIcon /></button>
                </div>
            </div>
            <div style={{ marginTop: '14px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: 'rgba(255,255,255,0.7)', marginBottom: '4px' }}><span>Progress</span><span>{progress}%</span></div>
                <div style={{ height: '8px', borderRadius: '4px', background: 'rgba(255,255,255,0.2)' }}>
                    <div style={{ height: '100%', borderRadius: '4px', background: colors.accent, width: `${progress}%`, transition: 'width 0.5s ease' }} />
                </div>
            </div>
            {devMode && (
                <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(255,255,255,0.2)' }}>
                    <p style={{ fontSize: '12px', color: 'rgba(255,255,255,0.7)', marginBottom: '8px' }}>Dev Mode: Skip to phase</p>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                        {phaseOrder.map(p => (<button key={p} onClick={() => setPhase(p)} style={{ padding: '4px 10px', borderRadius: '6px', border: 'none', fontSize: '12px', cursor: 'pointer', background: phase === p ? 'white' : 'rgba(255,255,255,0.2)', color: phase === p ? colors.primary : 'white' }}>{p}</button>))}
                    </div>
                </div>
            )}
        </div>
    );

    // ─── Glossary ────────────────────────────────────────
    const GlossaryModal = () => (
        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '16px', zIndex: 50 }}>
            <div style={{ background: 'white', borderRadius: '16px', maxWidth: '420px', width: '100%', maxHeight: '80vh', overflow: 'auto' }}>
                <div style={{ padding: '16px', borderBottom: '1px solid #eee', display: 'flex', justifyContent: 'space-between', alignItems: 'center', position: 'sticky', top: 0, background: 'white', borderRadius: '16px 16px 0 0' }}>
                    <strong style={{ color: colors.primary }}>Glossary</strong>
                    <button onClick={() => setShowGlossary(false)} style={{ background: 'none', border: 'none', fontSize: '22px', cursor: 'pointer', color: '#999' }}>&times;</button>
                </div>
                <div style={{ padding: '16px' }}>
                    <div style={{ marginBottom: '14px' }}>
                        <p style={{ fontWeight: 600, color: colors.primary, fontSize: '14px' }}>Cash Receipts and Disbursements Journal</p>
                        <p style={{ fontSize: '13px', color: colors.textMuted, marginTop: '4px' }}>A record that separates cash coming in from cash going out.</p>
                    </div>
                    <div>
                        <p style={{ fontWeight: 600, color: colors.primary, fontSize: '14px' }}>Accounting Entity</p>
                        <p style={{ fontSize: '13px', color: colors.textMuted, marginTop: '4px' }}>A business or organization treated as a separate unit for accounting purposes, with its own records and financial statements.</p>
                    </div>
                </div>
            </div>
        </div>
    );

    const ContinueButton = ({ onClick, children = "Continue" }) => (
        <button onClick={() => { playContinueClick(); onClick(); }} style={{ ...s.btn, ...s.primaryBtn, marginTop: '16px' }}>{children} <ChevronRight /></button>
    );

    // ─── PHASE: Welcome ──────────────────────────────────
    const renderWelcome = () => (
        <div className="fade-in">
            <div style={s.narrativeBlock}>
                <p>Sofia has assembled a working system: two separate journals, one for each entity. ClearCurrent is starting to see first sales. PureAccess is preparing for its first distribution cycle. Both entities need supplies.</p>
                <p style={{ marginTop: '12px' }}>One morning, Sofia places an order for buckets&thinsp;&mdash;&thinsp;100 plastic buckets at $3 each, for $300 total. But these buckets aren't all the same story. Some will become inventory for ClearCurrent (containers for filters sold to customers). Some will become supplies for PureAccess (containers for filters distributed to communities). The purchase is one transaction. The records are two.</p>
            </div>

            <div style={{ ...s.card, border: `2px solid ${colors.primary}` }}>
                <p style={{ fontWeight: 700, color: colors.primary, marginBottom: '8px' }}>In This Chapter</p>
                <p style={{ fontSize: '15px', color: colors.textDark, lineHeight: 1.6 }}>You'll record the same transaction for two different entities and see what changes — and what doesn't.</p>
            </div>

            <div style={{ marginBottom: '16px' }}>
                <button onClick={() => setShowCreativeNote(!showCreativeNote)} style={{ width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 14px', borderRadius: '10px', border: 'none', background: colors.clayLight, color: colors.earthDark, cursor: 'pointer', fontSize: '14px' }}>
                    <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}><InfoIcon /><span style={{ fontWeight: 500 }}>A Note on Creative Liberties</span></span>
                    {showCreativeNote ? <ChevronUp /> : <ChevronDown />}
                </button>
                {showCreativeNote && (
                    <div style={{ marginTop: '8px', padding: '16px', borderRadius: '10px', background: 'white', border: `1px solid ${colors.earthLight}`, fontSize: '14px', color: colors.earthDark, lineHeight: 1.6 }}>
                        <p style={{ marginBottom: '10px' }}>The bucket purchase is presented as a single, clean split. In practice, allocating shared purchases between entities involves judgment calls, partial receipts, and sometimes messy compromise. This is fiction in service of teaching accounting concepts.</p>
                        <p style={{ fontStyle: 'italic' }}>This is fiction in service of teaching accounting concepts.</p>
                    </div>
                )}
            </div>

            <ContinueButton onClick={() => setPhase('clearcurrent')}>Begin Chapter</ContinueButton>
        </div>
    );

    // ─── PHASE: ClearCurrent ─────────────────────────────
    const renderClearCurrent = () => (
        <div className="fade-in">
            <div style={s.narrativeBlock}>
                <p>ClearCurrent sells filters to paying customers. When ClearCurrent buys buckets, those buckets become part of the product it sells.</p>
            </div>

            <div style={s.card}>
                <p style={{ fontWeight: 700, color: colors.primary, marginBottom: '10px' }}>ClearCurrent's Purchase</p>
                <div style={{ padding: '14px 16px', borderRadius: '10px', border: `2px solid ${colors.clearcurrent}`, background: colors.clearcurrentBg, marginBottom: '14px' }}>
                    <p style={{ fontSize: '14px', color: colors.textDark, marginBottom: '8px' }}><span style={{ fontWeight: 600 }}>Date:</span> Today</p>
                    <p style={{ fontSize: '14px', color: colors.textDark, marginBottom: '8px' }}><span style={{ fontWeight: 600 }}>Vendor:</span> Plastic Supply Co.</p>
                    <p style={{ fontSize: '14px', color: colors.textDark, marginBottom: '8px' }}><span style={{ fontWeight: 600 }}>Description:</span> 50 buckets at $3 each</p>
                    <p style={{ fontSize: '16px', color: colors.textDark, fontWeight: 700 }}>Total: $150</p>
                </div>

                {/* Q1 */}
                <p style={{ fontWeight: 600, color: colors.textDark, marginBottom: '14px', fontSize: '15px' }}>
                    <span style={{ color: colors.primary }}>Question:</span> ClearCurrent bought 50 buckets at $3 each. What are these buckets to ClearCurrent?
                </p>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                    {[
                        { value: 'inventory', label: 'Inventory for sale' },
                        { value: 'supplies', label: 'Supplies for distribution' }
                    ].map(opt => {
                        const isThis = q1Choice === opt.value;
                        const isCorrect = opt.value === 'inventory';
                        let borderColor = isThis ? colors.primary : colors.earthLight;
                        let bg = isThis ? '#eef3fa' : 'white';
                        if (q1Submitted) {
                            if (isCorrect) { borderColor = colors.success; bg = colors.successBg; }
                            else if (isThis && !isCorrect) { borderColor = colors.error; bg = colors.errorBg; }
                        }
                        return (
                            <button key={opt.value} onClick={() => handleQ1(opt.value)} disabled={q1Submitted}
                                style={{ padding: '16px', borderRadius: '10px', border: `2px solid ${borderColor}`, background: bg, cursor: q1Submitted ? 'default' : 'pointer', fontWeight: 700, fontSize: '15px', color: colors.textDark }}>
                                {opt.label}
                            </button>
                        );
                    })}
                </div>

                {q1Attempts > 0 && q1Attempts < 3 && !q1Submitted && (
                    <div style={s.hintBox}>
                        <strong>Hint {q1Attempts}/2: </strong>
                        {q1Attempts === 1 && "Think about ClearCurrent's purpose. What does it do with the buckets?"}
                        {q1Attempts === 2 && "ClearCurrent sells filters to paying customers. The buckets are containers for a product being sold."}
                    </div>
                )}

                {q1Submitted && q1Attempts < 3 && (
                    <div style={s.successBox}><span style={{ color: colors.success, marginRight: '6px' }}>✓</span> Right. ClearCurrent's records <em>show</em> these buckets as inventory — items held to be sold to customers.</div>
                )}

                {q1Submitted && q1Attempts >= 3 && (
                    <div style={s.revealBox}><strong>Inventory for sale.</strong> ClearCurrent's records <em>show</em> these buckets as inventory — items held to be sold to customers.</div>
                )}
            </div>

            {q1Submitted && <ContinueButton onClick={() => setPhase('pureaccess')}>ClearCurrent's Done</ContinueButton>}
        </div>
    );

    // ─── PHASE: PureAccess ───────────────────────────────
    const renderPureAccess = () => (
        <div className="fade-in">
            <div style={s.narrativeBlock}>
                <p>PureAccess distributes filters to communities without clean water. No one pays. When PureAccess buys buckets, those buckets carry filters to people who need them.</p>
            </div>

            <div style={s.card}>
                <p style={{ fontWeight: 700, color: colors.primary, marginBottom: '10px' }}>PureAccess's Purchase</p>
                <div style={{ padding: '14px 16px', borderRadius: '10px', border: `2px solid ${colors.pureaccess}`, background: colors.pureaccessBg, marginBottom: '14px' }}>
                    <p style={{ fontSize: '14px', color: colors.textDark, marginBottom: '8px' }}><span style={{ fontWeight: 600 }}>Date:</span> Today</p>
                    <p style={{ fontSize: '14px', color: colors.textDark, marginBottom: '8px' }}><span style={{ fontWeight: 600 }}>Vendor:</span> Plastic Supply Co.</p>
                    <p style={{ fontSize: '14px', color: colors.textDark, marginBottom: '8px' }}><span style={{ fontWeight: 600 }}>Description:</span> 50 buckets at $3 each</p>
                    <p style={{ fontSize: '16px', color: colors.textDark, fontWeight: 700 }}>Total: $150</p>
                </div>

                {/* Q2 */}
                <p style={{ fontWeight: 600, color: colors.textDark, marginBottom: '14px', fontSize: '15px' }}>
                    <span style={{ color: colors.primary }}>Question:</span> PureAccess bought 50 buckets at $3 each. What are these buckets to PureAccess?
                </p>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                    {[
                        { value: 'inventory', label: 'Inventory for sale' },
                        { value: 'supplies', label: 'Supplies for distribution' }
                    ].map(opt => {
                        const isThis = q2Choice === opt.value;
                        const isCorrect = opt.value === 'supplies';
                        let borderColor = isThis ? colors.primary : colors.earthLight;
                        let bg = isThis ? '#eef3fa' : 'white';
                        if (q2Submitted) {
                            if (isCorrect) { borderColor = colors.success; bg = colors.successBg; }
                            else if (isThis && !isCorrect) { borderColor = colors.error; bg = colors.errorBg; }
                        }
                        return (
                            <button key={opt.value} onClick={() => handleQ2(opt.value)} disabled={q2Submitted}
                                style={{ padding: '16px', borderRadius: '10px', border: `2px solid ${borderColor}`, background: bg, cursor: q2Submitted ? 'default' : 'pointer', fontWeight: 700, fontSize: '15px', color: colors.textDark }}>
                                {opt.label}
                            </button>
                        );
                    })}
                </div>

                {q2Attempts > 0 && q2Attempts < 3 && !q2Submitted && (
                    <div style={s.hintBox}>
                        <strong>Hint {q2Attempts}/2: </strong>
                        {q2Attempts === 1 && "Think about PureAccess's purpose. It doesn't sell anything."}
                        {q2Attempts === 2 && "PureAccess gives filters away. The buckets are supplies consumed in pursuing its mission, not products for sale."}
                    </div>
                )}

                {q2Submitted && q2Attempts < 3 && (
                    <div style={s.successBox}><span style={{ color: colors.success, marginRight: '6px' }}>✓</span> Right. PureAccess's records <em>show</em> these buckets as supplies — items used in carrying out the mission.</div>
                )}

                {q2Submitted && q2Attempts >= 3 && (
                    <div style={s.revealBox}><strong>Supplies for distribution.</strong> PureAccess's records <em>show</em> these buckets as supplies — items used in carrying out the mission.</div>
                )}
            </div>

            {q2Submitted && <ContinueButton onClick={() => setPhase('comparison')}>See Both Records</ContinueButton>}
        </div>
    );

    // ─── PHASE: Comparison ───────────────────────────────
    const renderComparison = () => (
        <div className="fade-in">
            <div style={s.narrativeBlock}>
                <p>The same supplier, the same date, the same buckets, the same price. But in the records, they tell different stories.</p>
            </div>

            {/* Side-by-side comparison */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px' }}>
                <div style={{ padding: '16px', borderRadius: '12px', border: `2px solid ${colors.clearcurrent}`, background: colors.clearcurrentBg }}>
                    <p style={{ fontWeight: 700, color: colors.clearcurrent, marginBottom: '12px', fontSize: '14px', textAlign: 'center' }}>ClearCurrent</p>
                    <div style={{ fontSize: '13px', color: colors.textDark, marginBottom: '8px' }}>
                        <p style={{ marginBottom: '4px' }}>50 buckets × $3</p>
                        <p style={{ fontWeight: 700 }}>= $150</p>
                    </div>
                    <div style={{ paddingTop: '10px', borderTop: `2px solid ${colors.clearcurrent}`, fontSize: '13px', fontWeight: 600, color: colors.clearcurrent }}>Inventory for sale</div>
                </div>

                <div style={{ padding: '16px', borderRadius: '12px', border: `2px solid ${colors.pureaccess}`, background: colors.pureaccessBg }}>
                    <p style={{ fontWeight: 700, color: colors.pureaccess, marginBottom: '12px', fontSize: '14px', textAlign: 'center' }}>PureAccess</p>
                    <div style={{ fontSize: '13px', color: colors.textDark, marginBottom: '8px' }}>
                        <p style={{ marginBottom: '4px' }}>50 buckets × $3</p>
                        <p style={{ fontWeight: 700 }}>= $150</p>
                    </div>
                    <div style={{ paddingTop: '10px', borderTop: `2px solid ${colors.pureaccess}`, fontSize: '13px', fontWeight: 600, color: colors.pureaccess }}>Supplies for distribution</div>
                </div>
            </div>

            {/* Q3: Two-choice with explanation */}
            <div style={s.card}>
                <p style={{ fontWeight: 600, color: colors.textDark, marginBottom: '14px', fontSize: '15px' }}>
                    <span style={{ color: colors.primary }}>Question:</span> Did the bucket change when it moved from ClearCurrent's records to PureAccess's records?
                </p>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                    {[
                        { value: 'yes', label: 'Yes' },
                        { value: 'no', label: 'No' }
                    ].map(opt => {
                        const isThis = q3Choice === opt.value;
                        const isCorrect = opt.value === 'no';
                        let borderColor = isThis ? colors.primary : colors.earthLight;
                        let bg = isThis ? '#eef3fa' : 'white';
                        if (q3Submitted) {
                            if (isCorrect) { borderColor = colors.success; bg = colors.successBg; }
                            else if (isThis && !isCorrect) { borderColor = colors.error; bg = colors.errorBg; }
                        }
                        return (
                            <button key={opt.value} onClick={() => !q3Submitted && setQ3Choice(opt.value)} disabled={q3Submitted}
                                style={{ padding: '14px', borderRadius: '10px', border: `2px solid ${borderColor}`, background: bg, cursor: q3Submitted ? 'default' : 'pointer', fontWeight: 700, fontSize: '14px', color: colors.textDark }}>
                                {opt.label}
                            </button>
                        );
                    })}
                </div>

                {q3Choice && !q3Submitted && (
                    <div style={{ marginBottom: '12px' }}>
                        <label style={{ fontSize: '13px', fontWeight: 600, color: colors.textDark, display: 'block', marginBottom: '6px' }}>Explain your thinking:</label>
                        <textarea
                            value={q3Explanation}
                            onChange={e => setQ3Explanation(e.target.value)}
                            placeholder="Why did you choose that?"
                            rows={2}
                            disabled={q3Submitted}
                            style={{ width: '100%', padding: '10px', border: `2px solid ${colors.earthLight}`, borderRadius: '8px', fontSize: '14px', fontFamily: "'Source Sans 3', sans-serif", resize: 'none' }}
                        />
                    </div>
                )}

                {q3Choice && !q3Submitted && (
                    <button onClick={handleQ3Submit} disabled={!q3Explanation.trim()}
                        style={{ ...s.btn, ...s.primaryBtn, opacity: q3Explanation.trim() ? 1 : 0.5 }}>Check</button>
                )}

                {q3Attempts > 0 && q3Attempts < 3 && !q3Submitted && (
                    <div style={s.hintBox}>
                        <strong>Hint {q3Attempts}/2: </strong>
                        {q3Attempts === 1 && "Think about the physical bucket. Is it a different bucket?"}
                        {q3Attempts === 2 && "The bucket is the same plastic bucket from the same supplier. What changed is the words on the record — 'inventory' versus 'supplies.'"}
                    </div>
                )}

                {q3Submitted && q3Attempts < 3 && (
                    <div style={s.successBox}>
                        <span style={{ color: colors.success, marginRight: '6px' }}>✓</span>
                        <strong>No.</strong> The bucket is the same bucket. Nothing physical changed. The records <em>show</em> different things because the entities have different purposes. The accounting representation changed; the economic reality didn't.
                    </div>
                )}

                {q3Submitted && q3Attempts >= 3 && (
                    <div style={s.revealBox}>
                        <strong>No.</strong> The bucket is the same bucket. Nothing physical changed. The records <em>show</em> different things because the entities have different purposes. The accounting representation changed; the economic reality didn't.
                    </div>
                )}
            </div>

            {/* Q4: Open reflection */}
            {q3Submitted && (
                <div style={s.card} className="fade-in">
                    <p style={{ fontWeight: 600, color: colors.textDark, marginBottom: '14px', fontSize: '15px' }}>
                        <span style={{ color: colors.primary }}>Reflection:</span> If the bucket didn't change, what did? What determines whether the records say 'inventory' or 'supplies'?
                    </p>

                    <textarea
                        value={q4Answer}
                        onChange={e => setQ4Answer(e.target.value)}
                        placeholder="Your thoughts..."
                        rows={3}
                        disabled={q4Submitted}
                        style={{ width: '100%', padding: '12px', border: `2px solid ${colors.earthLight}`, borderRadius: '8px', fontSize: '14px', fontFamily: "'Source Sans 3', sans-serif", marginBottom: '12px', resize: 'none' }}
                    />

                    {!q4Submitted && (
                        <button onClick={handleQ4Submit} disabled={q4Answer.trim().length < 10}
                            style={{ ...s.btn, ...s.primaryBtn, opacity: q4Answer.trim().length >= 10 ? 1 : 0.5 }}>Submit</button>
                    )}

                    {q4Submitted && (
                        <div style={s.insightBox}>
                            <p style={{ fontWeight: 600, marginBottom: '8px', color: colors.earthDark }}>The Key Insight</p>
                            <p>The entity's purpose determines how the records describe the same physical object. ClearCurrent exists to sell; PureAccess exists to serve. The same bucket, recorded by two entities, tells two different stories. Neither story is wrong — but neither is the complete truth either. The records are a lens, not a mirror.</p>
                        </div>
                    )}
                </div>
            )}

            {q4Submitted && <ContinueButton onClick={() => setPhase('complete')}>See What You Discovered</ContinueButton>}
        </div>
    );

    // ─── PHASE: Complete ─────────────────────────────────
    const renderComplete = () => (
        <div className="fade-in">
            <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                <div style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center', width: '80px', height: '80px', borderRadius: '50%', background: colors.accent, marginBottom: '14px' }}><TrophyIcon /></div>
                <h2 style={{ color: colors.primary, fontSize: '22px', fontWeight: 700 }}>Chapter Complete!</h2>
            </div>

            <div style={{ ...s.card, border: `2px solid ${colors.success}` }}>
                <p style={{ fontWeight: 700, color: colors.primary, marginBottom: '12px' }}>What You Discovered</p>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {[
                        `The same physical transaction can look different in different entities\u2019 records`,
                        'What changed is the accounting representation, not the economic reality',
                        `The entity\u2019s purpose shapes how the records describe things`,
                        'The records show inventory or supplies; the entity has a bucket',
                    ].map((item, i) => (
                        <div key={i} style={{ display: 'flex', gap: '8px', alignItems: 'flex-start', fontSize: '14px', color: colors.earthDark }}>
                            <span style={{ color: colors.success, flexShrink: 0, marginTop: '1px' }}>✓</span><span>{item}</span>
                        </div>
                    ))}
                </div>
            </div>

            <div style={s.insightBox}>
                <p style={{ fontWeight: 600, marginBottom: '8px' }}>The Deeper Point</p>
                <p>Accounting doesn't just record reality — it frames reality according to purpose. Two entities looking at the same bucket see different things in their records. This framing is useful: it tells you something about each entity's mission. But it also means the records are always shaped by choices about how to represent things.</p>
            </div>

            <div style={{ ...s.card, background: colors.clayLight }}>
                <p style={{ fontWeight: 700, color: colors.primary, marginBottom: '8px' }}>Coming Next</p>
                <p style={{ fontSize: '14px', color: colors.earthDark, lineHeight: 1.5 }}>
                    Sofia has built a working system — cash journals, entity separation, two-sided records. She doesn't know it, but she's been reinventing methods that already exist.
                </p>
                <p style={{ fontWeight: 700, color: colors.primary, marginTop: '10px' }}>Next: Chapter 5 — You're Reinventing the Wheel</p>
            </div>

            <button onClick={() => { playContinueClick(); }} style={{ ...s.btn, ...s.primaryBtn, marginTop: '12px' }}>Next Chapter <ChevronRight /></button>
            <button onClick={handleRestart} style={{ ...s.btn, ...s.outlineBtn, marginTop: '8px' }}><RestartIcon /> Restart Chapter</button>
        </div>
    );

    // ─── Render ──────────────────────────────────────────
    const renderPhase = () => {
        switch (phase) {
            case 'welcome': return renderWelcome();
            case 'clearcurrent': return renderClearCurrent();
            case 'pureaccess': return renderPureAccess();
            case 'comparison': return renderComparison();
            case 'complete': return renderComplete();
            default: return null;
        }
    };

    return (
        <div style={s.container}>
            <Header />
            <main style={s.main}>{renderPhase()}</main>
            {showGlossary && <GlossaryModal />}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<Chapter4 />);
    </script>
</body>
</html>
